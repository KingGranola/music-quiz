<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>音楽ジャンル知識診断</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:title" content="音楽ジャンル知識診断" />
  <meta property="og:description" content="30問であなたの音楽ジャンル知識を分析！どのジャンルに詳しい？" />
  <meta property="og:image" content="https://yourname.github.io/music-quiz/img/og-image.png" />
  <meta property="og:url" content="https://yourname.github.io/music-quiz/" />
  <meta name="twitter:card" content="summary_large_image" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

  <div id="container">
    <h1>音楽ジャンル知識診断</h1>
    <div id="progress">
      <div id="progress-bar"></div>
      <span id="progress-text">1 / 30問</span>
    </div>
    <div id="genre" class="genre-label"></div>
    <div id="question">読み込み中...</div>
    <div id="buttons">
      <button class="btn-level-3" onclick="answer(3)">5曲以上知っている</button>
      <button class="btn-level-2" onclick="answer(2)">1曲くらいは知っている</button>
      <button class="btn-level-1" onclick="answer(1)">アーティスト名は知っている</button>
      <button class="btn-level-0" onclick="answer(0)">名前も知らない</button>
    </div>

    <canvas id="chart" style="display: none;"></canvas>
    <div id="result" style="display: none;"></div>

    <div id="share" style="display: none; margin-top: 30px;">
      <a id="twitter-share-button" class="share-btn twitter" target="_blank">Twitterでシェア</a>
      <a id="line-share-button" class="share-btn line" target="_blank">LINEでシェア</a>
    </div>

  </div>
  <script src="js/artistData.js"></script>
  <script>
    let current = 0;
    const scores = {};
    const totalQuestions = 30; // 問題数を30問に変更

    const questions = Object.keys(artistData)
      .map(genre => artistData[genre].sort(() => 0.5 - Math.random()).slice(0, 3)) // 各ジャンルから3問ずつ
      .flat()
      .sort(() => 0.5 - Math.random())
      .slice(0, totalQuestions); // 全体で30問になるように調整

    function updateProgress() {
      const progressText = document.getElementById("progress-text");
      const progressBar = document.getElementById("progress-bar");
      const progress = ((current + 1) / totalQuestions) * 100;
      progressBar.style.width = `${progress}%`;
      progressText.innerText = `${current + 1} / ${totalQuestions}問`;
    }

    function showQuestion() {
      if (current >= totalQuestions) return showResult();
      const q = questions[current];
      document.getElementById("genre").innerText = `ジャンル：${q.genre}`;
      document.getElementById("question").innerText = `${q.artist_ja || q.artist_en}（${q.artist_en}）をどれくらい知ってる？`; // 日本語名がない場合に英語名を表示
      updateProgress();
    }

    function answer(point) {
      const q = questions[current];
      if (!scores[q.genre]) scores[q.genre] = {
        score: 0,
        max: 0
      };
      scores[q.genre].score += point;
      scores[q.genre].max += 3;
      current++;
      showQuestion();
    }

    function showResult() {
      document.getElementById("question").style.display = "none";
      document.getElementById("buttons").style.display = "none";
      document.getElementById("progress").style.display = "none";
      document.getElementById("genre").style.display = "none";
      const labels = Object.keys(scores);
      const data = labels.map(g => Math.round((scores[g].score / scores[g].max) * 100));

      const ctx = document.getElementById("chart").getContext("2d");
      document.getElementById("chart").style.display = "block";

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: '知識度（%）',
            data,
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)'
          }]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              suggestedMin: 0,
              suggestedMax: 100
            }
          }
        }
      });

      const result = document.getElementById("result");
      let resultText = `<h2>診断完了！</h2><p>ジャンルごとの知識度をご確認ください 🎧</p>`;

      // 強いジャンル、弱いジャンルを特定
      const sortedGenres = labels.map((label, index) => ({
        genre: label,
        percentage: data[index]
      })).sort((a, b) => b.percentage - a.percentage);

      const topGenre = sortedGenres[0].genre;
      const worstGenre = sortedGenres[sortedGenres.length - 1].genre;

      resultText += `<p>あなたの得意なジャンルは「${topGenre}」です！</p>`;
      resultText += `<p>もっと知りたいジャンルは「${worstGenre}」かもしれません。</p>`;

      // おすすめアーティストを提示 (上位3ジャンルからランダムに1アーティストずつ提示)
      resultText += `<p>あなたへのおすすめアーティストはこちら！</p><ul>`;
      for (let i = 0; i < Math.min(3, sortedGenres.length); i++) {
        const genre = sortedGenres[i].genre;
        const randomIndex = Math.floor(Math.random() * artistData[genre].length);
        const recommendedArtist = artistData[genre][randomIndex].artist_ja || artistData[genre][randomIndex].artist_en;
        resultText += `<li>${genre}: ${recommendedArtist}</li>`;
      }
      resultText += `</ul>`;

      result.innerHTML = resultText;
      result.style.display = "block";

      // SNSシェアボタン
      const shareText = `🎵音楽ジャンル診断の結果🎵\n私は「${topGenre}」に詳しいタイプでした！`;
      const url = encodeURIComponent(window.location.href);
      document.getElementById("twitter-share-button").href =
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${url}`;
      document.getElementById("line-share-button").href =
        `https://social-plugins.line.me/lineit/share?url=${url}`;
      document.getElementById("share").style.display = "block";
    }

    showQuestion();
  </script>
</body>

</html>
